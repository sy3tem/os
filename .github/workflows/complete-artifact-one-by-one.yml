name: "Build One by One (anyone)"
on:
  workflow_dispatch:
    inputs:
      armbian_target:
        type: choice
        description: 'Build'
        required: false
        options:
        - kernel
        - build
        default: build

      armbian_kernel_branch:
        type: choice
        description: 'Kernel branch'
        options:
        - legacy
        - current
        - edge
        - vendor  # 添加 vendor 选项
        default: 'current'

      armbian_release:
        type: choice
        description: 'Userspace'
        options:
        - jammy
        - mantic
        - bookworm
        - trixie
        - sid
        default: 'jammy'

      armbian_ui:
        type: choice
        description: 'User interface (not all works)'
        options:
        - minimal
        - server
        - xfce
        - gnome
        - cinnamon
        - i3-wm
        - kde-plasma
        default: 'minimal'

      armbian_version:
        description: 'Version'
        required: false
        default: ''

      armbian_board:
        type: choice
        description: 'Board'
        options:
        # ... (所有板卡选项保持不变)
        - mangopi-m28k  # 确保此板卡在列表中
        # ... (其他板卡选项)

jobs:
  build:
    name: "Build Armbian"
    runs-on: ubuntu-latest
    steps:
      # 第一步：设置 binfmt 支持
      - name: Set up binfmt support
        run: |
          sudo apt-get update
          sudo apt-get install -y qemu-user-static binfmt-support
          sudo update-binfmts --enable qemu-arm
          sudo update-binfmts --enable qemu-aarch64
          sudo update-binfmts --enable qemu-riscv64
          sudo service binfmt-support start

      # 第二步：根据板卡动态调整内核分支
      - name: Determine kernel branch
        id: kernel_branch
        run: |
          if [ "${{ inputs.armbian_board }}" = "mangopi-m28k" ]; then
            echo "branch=vendor" >> $GITHUB_OUTPUT
          else
            echo "branch=${{ inputs.armbian_kernel_branch }}" >> $GITHUB_OUTPUT
          fi

      # 第三步：执行构建
      - uses: armbian/build@v25.5.1
        with:
          armbian_token: "${{ secrets.GITHUB_TOKEN }}"
          armbian_target: "${{ inputs.armbian_target }}"
          armbian_release: "${{ inputs.armbian_release }}"
          armbian_kernel_branch: "${{ steps.kernel_branch.outputs.branch }}"
          armbian_ui: "${{ inputs.armbian_ui }}"
          armbian_board: "${{ inputs.armbian_board }}"
          armbian_release_tittle: "Armbian SDK"
          armbian_release_body: "Virtual images for x86 and arm64"
          armbian_pgp_key: "${{ secrets.GPG_KEY1 }}"
          armbian_pgp_password: "${{ secrets.GPG_PASSPHRASE1 }}"
